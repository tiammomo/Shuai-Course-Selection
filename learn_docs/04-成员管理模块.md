# 成员管理模块

## 1. 模块概述

成员管理模块负责系统中三类用户 (管理员、教师、学生) 的全生命周期管理，包括用户的创建、查询、更新和删除操作。

---

## 2. 数据模型

### 2.1 Member 实体

```go
type Member struct {
    gorm.Model
    UserID     int    `gorm:"primaryKey;autoIncrement" json:"user_id"`
    Username   string `gorm:"size:50;uniqueIndex;not null" json:"username"`
    Password   string `gorm:"size:255;not null" json:"-"`           // 不返回给前端
    Nickname   string `gorm:"size:100;not null" json:"nickname"`
    UserType   int    `gorm:"not null" json:"user_type"`
    IsDeleted  int    `gorm:"default:0;not null" json:"is_deleted"`
    CreatedAt  time.Time `json:"created_at"`
    UpdatedAt  time.Time `json:"updated_at"`
}
```

### 2.2 字段说明

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| UserID | INT | PK, AUTO_INCREMENT | 用户ID |
| Username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名 (登录账号) |
| Password | VARCHAR(255) | NOT NULL | 密码 (bcrypt 加密) |
| Nickname | VARCHAR(100) | NOT NULL | 用户昵称 |
| UserType | TINYINT | NOT NULL | 用户类型 |
| IsDeleted | TINYINT | NOT NULL DEFAULT 0 | 软删除标志 |

### 2.3 UserType 枚举

| 值 | 角色 | 说明 |
|---|------|------|
| 1 | 管理员 | 系统管理，完全访问权限 |
| 2 | 教师 | 授课教师，可管理所授课程 |
| 3 | 学生 | 选课学生，可进行选课操作 |

---

## 3. 仓储接口

### 3.1 IMemberRepo 接口定义

```go
type IMemberRepo interface {
    Create(ctx context.Context, member *Member) error
    GetByID(ctx context.Context, id int) (*Member, error)
    GetByUsername(ctx context.Context, username string) (*Member, error)
    List(ctx context.Context, offset, limit int) ([]*Member, error)
    Update(ctx context.Context, id int, updates map[string]interface{}) error
    Delete(ctx context.Context, id int) error
    Count(ctx context.Context) (int64, error)
}
```

### 3.2 核心方法实现

#### GetByUsername - 根据用户名查询

```go
func (r *MemberRepoImpl) GetByUsername(ctx context.Context, username string) (*Member, error) {
    var member Member
    err := r.db.WithContext(ctx).Where("username = ? AND is_deleted = 0", username).First(&member).Error
    if err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, nil
        }
        return nil, err
    }
    return &member, nil
}
```

#### List - 分页查询

```go
func (r *MemberRepoImpl) List(ctx context.Context, offset, limit int) ([]*Member, error) {
    var members []*Member
    err := r.db.WithContext(ctx).
        Where("is_deleted = 0").
        Offset(offset).
        Limit(limit).
        Order("created_at DESC").
        Find(&members).Error
    return members, err
}
```

#### Delete - 软删除

```go
func (r *MemberRepoImpl) Delete(ctx context.Context, id int) error {
    return r.db.WithContext(ctx).Model(&Member{}).
        Where("user_id = ?", id).
        Update("is_deleted", 1).Error
}
```

---

## 4. 领域服务

### 4.1 MemberService 结构

```go
type MemberService struct {
    memberRepo repository.IMemberRepo
}
```

### 4.2 核心业务逻辑

#### Create - 创建成员

```go
func (s *MemberService) Create(ctx context.Context, req *model.CreateMemberRequest) (*model.Member, error) {
    // 检查用户名是否已存在
    existing, err := s.memberRepo.GetByUsername(ctx, req.Username)
    if err != nil {
        return nil, err
    }
    if existing != nil {
        return nil, errcode.UsernameExists
    }

    // 加密密码
    hashedPassword, err := encrypt.Encrypt(req.Password)
    if err != nil {
        return nil, err
    }

    member := &model.Member{
        Username:   req.Username,
        Password:   hashedPassword,
        Nickname:   req.Nickname,
        UserType:   req.UserType,
        IsDeleted:  0,
    }

    if err := s.memberRepo.Create(ctx, member); err != nil {
        return nil, err
    }

    return member, nil
}
```

---

## 5. API 接口

### 5.1 路由配置

```go
member := v1.Group("/member")
{
    member.GET("", r.memberHandler.GetMember)
    member.GET("/list", r.memberHandler.GetMemberList)
    // 需要管理员权限
    member.POST("/create", r.authMiddleware.RequireAuth(), r.authMiddleware.RequireAdmin(), r.memberHandler.CreateMember)
    member.POST("/update", r.authMiddleware.RequireAuth(), r.authMiddleware.RequireAdmin(), r.memberHandler.UpdateMember)
    member.POST("/delete", r.authMiddleware.RequireAuth(), r.authMiddleware.RequireAdmin(), r.memberHandler.DeleteMember)
}
```

### 5.2 接口详情

#### GET /api/v1/member - 获取单个成员

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_id | string | 是 | 用户ID |

**响应示例**:
```json
{
  "code": 0,
  "data": {
    "user_id": "1",
    "username": "admin",
    "nickname": "管理员",
    "user_type": 1,
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

#### GET /api/v1/member/list - 获取成员列表

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| offset | int | 否 | 分页偏移，默认 0 |
| limit | int | 否 | 每页数量，默认 10 |

**响应示例**:
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "user_id": "1",
        "username": "admin",
        "nickname": "管理员",
        "user_type": 1
      }
    ],
    "total": 100
  }
}
```

#### POST /api/v1/member/create - 创建成员

**请求体**:
```json
{
  "username": "teacher001",
  "password": "Password123",
  "nickname": "张老师",
  "user_type": 2
}
```

#### POST /api/v1/member/update - 更新成员

**请求体**:
```json
{
  "user_id": "1",
  "nickname": "新昵称"
}
```

#### POST /api/v1/member/delete - 删除成员 (软删除)

**请求体**:
```json
{
  "user_id": "1"
}
```

---

## 6. 业务规则

### 6.1 创建成员规则

| 规则 | 说明 |
|------|------|
| 用户名唯一 | 不能与现有用户名重复 |
| 密码强度 | 至少 8 位，包含大小写字母和数字 |
| 用户类型 | 只能是 1 (管理员)、2 (教师)、3 (学生) |
| 软删除 | 不真正删除数据，只更新 is_deleted 标志 |

### 6.2 权限控制

| 操作 | 权限要求 |
|------|----------|
| 查看成员 | 需登录 |
| 创建成员 | 管理员 |
| 更新成员 | 管理员 |
| 删除成员 | 管理员 |

---

## 7. 关联关系

### 7.1 Member 与其他实体的关系

```
┌─────────────────────────────────────────────────────────────┐
│                        Member 关联关系                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Member (UserID) ──────► Course (TeacherID)               │
│        │                                                    │
│        │ Choice (StudentID)                                 │
│        │                                                    │
│        │ Bind (TeacherID)                                   │
│        ▼                                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 级联处理

| 操作 | 级联影响 |
|------|----------|
| 删除教师 | 自动删除相关 Bind 记录 |
| 删除学生 | 自动删除相关 Choice 记录 |
| 删除管理员 | 无级联影响 |

---

## 8. 核心代码文件

| 文件 | 路径 | 说明 |
|------|------|------|
| `member.go` | `internal/domain/model/member.go` | Member 实体定义 |
| `member_repo.go` | `internal/domain/repository/member_repo.go` | 仓储接口 |
| `member_repo_impl.go` | `internal/infrastructure/database/member_repo_impl.go` | 仓储实现 |
| `member_service.go` | `internal/domain/service/member_service.go` | 领域服务 |
| `member_handler.go` | `internal/interface/api/handler/member_handler.go` | HTTP 处理器 |

---

## 9. 学习要点

1. **软删除设计**: 使用 `is_deleted` 字段而非物理删除，保留数据历史
2. **用户名唯一性**: 创建时检查用户名是否已存在
3. **密码加密**: 永远不要存储明文密码，使用 bcrypt
4. **权限控制**: 敏感操作需要管理员权限
5. **GORM 使用**: 掌握 Where、First、Create 等基本操作
