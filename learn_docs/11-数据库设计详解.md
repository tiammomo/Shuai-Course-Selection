# 数据库设计详解

## 1. 数据库概述

### 1.1 数据库信息

| 属性 | 值 |
|------|-----|
| 数据库名 | course_select |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_unicode_ci |
| 存储引擎 | InnoDB |

### 1.2 数据库文件

| 文件 | 说明 |
|------|------|
| [sql/course_select_v1.01.sql](sql/course_select_v1.01.sql) | 初始数据库结构 |
| [sql/coures_select_v1.02.sql](sql/coures_select_v1.02.sql) | 扩展数据库结构 |

---

## 2. 数据表结构

### 2.1 member 表 (用户成员表)

```sql
CREATE TABLE `member` (
  `user_id` varchar(255) NOT NULL,
  `nickname` varchar(255) DEFAULT NULL,
  `username` varchar(255) DEFAULT NULL,
  `password` varchar(255) DEFAULT NULL,
  `user_type` int DEFAULT NULL,
  `is_deleted` tinyint(2) NOT NULL DEFAULT 0,
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;
```

**字段说明**:

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| user_id | VARCHAR(255) | - | 用户ID (主键，UUID) |
| username | VARCHAR(255) | - | 用户名 (唯一) |
| password | VARCHAR(255) | - | 密码 (bcrypt 加密) |
| nickname | VARCHAR(255) | - | 昵称 |
| user_type | INT | - | 用户类型 (1=管理员, 2=教师, 3=学生) |
| is_deleted | TINYINT(2) | 0 | 软删除标志 (0=正常, 1=已删除) |

**用户类型说明**:

| user_type | 角色 | 说明 |
|-----------|------|------|
| 1 | 管理员 | 系统管理，完全访问权限 |
| 2 | 教师 | 授课教师，可管理所授课程 |
| 3 | 学生 | 选课学生，可进行选课操作 |

---

### 2.2 course 表 (课程表)

```sql
CREATE TABLE `course` (
  `course_id` varchar(255) NOT NULL,
  `teacher_id` varchar(255) DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `capacity` int DEFAULT NULL,
  `cap_selected` int DEFAULT NULL,
  PRIMARY KEY (`course_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;
```

**字段说明**:

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| course_id | VARCHAR(255) | - | 课程ID (主键，UUID) |
| name | VARCHAR(255) | - | 课程名称 |
| capacity | INT | - | 课程容量 (最大选课人数) |
| cap_selected | INT | 0 | 已选人数 |
| teacher_id | VARCHAR(255) | NULL | 授课教师ID (外键) |

---

### 2.3 choice 表 (学生选课关系表)

```sql
CREATE TABLE `choice` (
  `student_id` varchar(255) NOT NULL,
  `course_id` varchar(255) NOT NULL,
  PRIMARY KEY (`student_id`,`course_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;
```

**字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| student_id | VARCHAR(255) | 学生ID (联合主键) |
| course_id | VARCHAR(255) | 课程ID (联合主键) |

**说明**: 使用联合主键保证一个学生不能重复选同一门课

---

### 2.4 bind 表 (教师课程绑定表)

```sql
CREATE TABLE `bind` (
  `teacher_id` varchar(255) NOT NULL,
  `course_id` varchar(255) NOT NULL,
  PRIMARY KEY (`teacher_id`,`course_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;
```

**字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| teacher_id | VARCHAR(255) | 教师ID (联合主键) |
| course_id | VARCHAR(255) | 课程ID (联合主键) |

**说明**: 使用联合主键保证一门课程只能被一位教师绑定

---

## 3. 实体关系图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           ER 图                                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────┐                    ┌─────────────┐
│   Member    │                    │   Course    │
├─────────────┤                    ├─────────────┤
│ user_id (PK)│──────┐             │course_id(PK)│
│ username    │      │             │ name        │
│ password    │      │ Bind         │ capacity    │
│ nickname    │      │             │cap_selected │
│ user_type   │      ▼             │ teacher_id ─┼──┐
│ is_deleted  │   ┌─────────┐      └─────────────┘  │
└─────────────┘   │  Bind   │                       │
                  ├─────────┤                       │
                  │teacher_id│◄─────────────────────┘
                  │course_id │
                  └─────────┘

                  ┌─────────┐
                  │ Choice  │
                  ├─────────┤
                  │student_id│◄──┐
                  │course_id ├───┤
                  └─────────┘    │
                                  │
                  ┌─────────┐    │
                  │ Member  │◄───┘
                  │(Student)│
                  └─────────┘
```

---

## 4. 视图

### 4.1 v_course_selection (课程选课统计视图)

```sql
CREATE VIEW v_course_selection AS
SELECT
    c.course_id,
    c.name,
    c.capacity,
    COUNT(ch.student_id) AS selected_count
FROM course c
LEFT JOIN choice ch ON c.course_id = ch.course_id
GROUP BY c.course_id, c.name, c.capacity;
```

**视图字段说明**:

| 字段 | 说明 |
|------|------|
| course_id | 课程ID |
| name | 课程名称 |
| capacity | 课程容量 |
| selected_count | 已选人数 |

**使用示例**:
```sql
-- 查询选课率超过 80% 的课程
SELECT * FROM v_course_selection
WHERE selected_count / capacity > 0.8;
```

---

### 4.2 v_member_detail (用户详情视图)

```sql
CREATE VIEW v_member_detail AS
SELECT
    user_id,
    username,
    nickname,
    CASE user_type
        WHEN 1 THEN '管理员'
        WHEN 2 THEN '教师'
        WHEN 3 THEN '学生'
        ELSE '未知'
    END AS user_type_name,
    is_deleted,
    created_at,
    updated_at
FROM member;
```

**视图字段说明**:

| 字段 | 说明 |
|------|------|
| user_id | 用户ID |
| username | 用户名 |
| nickname | 昵称 |
| user_type_name | 用户类型名称 |
| is_deleted | 删除状态 |
| created_at | 创建时间 |
| updated_at | 更新时间 |

---

## 5. 索引设计

### 5.1 索引列表

| 表名 | 索引类型 | 索引字段 | 说明 |
|------|----------|----------|------|
| member | PRIMARY KEY | user_id | 主键索引 |
| member | UNIQUE | username | 唯一索引，防止重复用户名 |
| member | INDEX | user_type | 普通索引，按类型查询 |
| member | INDEX | is_deleted | 普通索引，按删除状态筛选 |
| course | PRIMARY KEY | course_id | 主键索引 |
| course | INDEX | teacher_id | 普通索引，按教师查询课程 |
| choice | PRIMARY KEY | (student_id, course_id) | 联合主键索引 |
| choice | INDEX | course_id | 普通索引，按课程查询选课记录 |
| bind | PRIMARY KEY | (teacher_id, course_id) | 联合主键索引 |
| bind | INDEX | course_id | 普通索引，按课程查询绑定 |

### 5.2 索引优化建议

```sql
-- 常用查询场景对应的索引
-- 按用户名查询用户
CREATE INDEX idx_member_username ON member(username);

-- 按教师查询课程
CREATE INDEX idx_course_teacher ON course(teacher_id);

-- 查询某课程的所有选课学生
CREATE INDEX idx_choice_course ON choice(course_id);
```

---

## 6. Redis 缓存结构

### 6.1 课程剩余容量

```
Key: course:capacity
Type: Hash
Field: course_id
Value: remaining_count
```

**示例**:
```bash
# 设置课程容量
HSET course:capacity course_1 100 course_2 50

# 选课扣减
HINCRBY course:capacity course_1 -1

# 查询剩余容量
HGET course:capacity course_1
```

---

### 6.2 学生已选课程

```
Key: student:{student_id}:courses
Type: Set
Value: course_id
```

**示例**:
```bash
# 添加已选课程
SADD student:4:courses course_1 course_2

# 检查是否已选
SISMEMBER student:4:courses course_1

# 获取所有已选课程
SMEMBERS student:4:courses
```

---

### 6.3 Session 存储

```
Key: session:{sessionId}
Type: String (JSON)
Value: {user_id, username, nickname, user_type}
TTL: 3600 seconds
```

**示例值**:
```json
{
  "user_id": "1",
  "username": "admin",
  "nickname": "管理员",
  "user_type": 1
}
```

---

### 6.4 选课请求队列

```
Key: booking:queue
Type: List
Value: BookingMessage JSON
```

**消息格式**:
```json
{
  "student_id": "4",
  "course_id": "1",
  "timestamp": "2024-01-01T00:00:00Z"
}
```

---

## 7. 初始化数据

### 7.1 默认管理员账号

| username | password | user_type |
|----------|----------|-----------|
| admin | admin123 | 1 (管理员) |

**注意**: 生产环境请及时修改默认密码

### 7.2 示例数据

系统已预置部分测试数据：

**教师账号**:
| username | nickname | user_type |
|----------|----------|-----------|
| teacher01 | 张老师 | 2 |
| teacher02 | 李老师 | 2 |

**学生账号**:
| username | nickname | user_type |
|----------|----------|-----------|
| student01 | 学生A | 3 |
| student02 | 学生B | 3 |

---

## 8. 备份与恢复

### 8.1 备份命令

```bash
# 完整备份
mysqldump -u root -p course_select > backup_$(date +%Y%m%d).sql

# 仅备份结构
mysqldump -u root -p -d course_select > structure.sql

# 仅备份数据
mysqldump -u root -p -t course_select > data.sql
```

### 8.2 恢复命令

```bash
# 恢复数据
mysql -u root -p course_select < backup_20240101.sql
```

---

## 9. 性能优化建议

### 9.1 连接池配置

```go
// GORM 连接池配置
sqlDB.SetMaxIdleConns(10)   // 空闲连接数
sqlDB.SetMaxOpenConns(100)  // 最大连接数
```

### 9.2 慢查询优化

```sql
-- 开启慢查询日志
SET GLOBAL slow_query_log = ON;
SET GLOBAL long_query_time = 2;

-- 查看慢查询
SELECT * FROM mysql.slow_log;
```

### 9.3 分区建议

对于大规模数据，可考虑按时间分区：

```sql
-- 按年份分区选课记录
CREATE TABLE choice (
    student_id VARCHAR(255) NOT NULL,
    course_id VARCHAR(255) NOT NULL,
    selected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (student_id, course_id, selected_at)
) PARTITION BY RANGE (YEAR(selected_at)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```
