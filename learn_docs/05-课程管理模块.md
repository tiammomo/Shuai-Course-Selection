# 课程管理模块

## 1. 模块概述

课程管理模块负责课程的创建、查询、教师绑定等核心功能，是选课系统的基础模块。

---

## 2. 数据模型

### 2.1 Course 实体

```go
type Course struct {
    gorm.Model
    CourseID    int    `gorm:"primaryKey;autoIncrement" json:"course_id"`
    Name        string `gorm:"size:100;not null" json:"name"`
    Capacity    int    `gorm:"not null" json:"capacity"`       // 课程容量
    CapSelected int    `gorm:"default:0;not null" json:"cap_selected"` // 已选人数
    TeacherID   *int   `gorm:"default:null;index" json:"teacher_id"`   // 授课教师ID

    CreatedAt time.Time `json:"created_at"`
    UpdatedAt time.Time `json:"updated_at"`
}
```

### 2.2 字段说明

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| CourseID | INT | PK, AUTO_INCREMENT | 课程ID |
| Name | VARCHAR(100) | NOT NULL | 课程名称 |
| Capacity | INT | NOT NULL | 课程容量 (最大选课人数) |
| CapSelected | INT | NOT NULL DEFAULT 0 | 已选人数 |
| TeacherID | INT | FK → Member(UserID) | 授课教师ID，可为空 |

### 2.3 Bind 实体 (教师课程绑定)

```go
type Bind struct {
    TeacherID   int       `gorm:"primaryKey"`
    CourseID    int       `gorm:"primaryKey"`
    AssignedAt  time.Time `gorm:"autoCreateTime"`
}
```

---

## 3. 仓储接口

### 3.1 ICourseRepo 接口

```go
type ICourseRepo interface {
    Create(ctx context.Context, course *Course) error
    GetByID(ctx context.Context, id int) (*Course, error)
    List(ctx context.Context, offset, limit int) ([]*Course, error)
    Update(ctx context.Context, id int, updates map[string]interface{}) error
    Delete(ctx context.Context, id int) error
    Count(ctx context.Context) (int64, error)
}
```

### 3.2 IBindRepo 接口

```go
type IBindRepo interface {
    Create(ctx context.Context, bind *Bind) error
    GetByCourseID(ctx context.Context, courseID int) (*int, error)
    GetByTeacherID(ctx context.Context, teacherID int) ([]*Course, error)
    DeleteByCourseID(ctx context.Context, courseID int) error
    DeleteByTeacherID(ctx context.Context, teacherID int) error
}
```

### 3.3 IChoiceRepo 接口

```go
type IChoiceRepo interface {
    Create(ctx context.Context, choice *Choice) error
    GetByStudentAndCourse(ctx context.Context, studentID, courseID int) (*Choice, error)
    DeleteByStudent(ctx context.Context, studentID int) error
    DeleteByCourse(ctx context.Context, courseID int) error
    ListByStudent(ctx context.Context, studentID int) ([]*Choice, error)
    CountByCourse(ctx context.Context, courseID int) (int64, error)
}
```

---

## 4. 领域服务

### 4.1 CourseService 结构

```go
type CourseService struct {
    courseRepo repository.ICourseRepo
    bindRepo   repository.IBindRepo
    choiceRepo repository.IChoiceRepo
}
```

### 4.2 核心业务方法

#### Create - 创建课程

```go
func (s *CourseService) Create(ctx context.Context, req *model.CreateCourseRequest) (*model.Course, error) {
    course := &model.Course{
        Name:        req.Name,
        Capacity:    req.Cap,
        CapSelected: 0,
        TeacherID:   nil,  // 新建课程暂无教师
    }

    if err := s.courseRepo.Create(ctx, course); err != nil {
        return nil, err
    }

    return course, nil
}
```

#### BindCourse - 绑定课程到教师

```go
func (s *CourseService) BindCourse(ctx context.Context, courseID, teacherID string) error {
    cID, _ := strconv.Atoi(courseID)
    tID, _ := strconv.Atoi(teacherID)

    // 1. 检查课程是否存在
    course, err := s.courseRepo.GetByID(ctx, cID)
    if err != nil {
        return err
    }
    if course == nil {
        return errcode.CourseNotExisted
    }

    // 2. 检查课程是否已被绑定
    if course.TeacherID != nil {
        return errcode.CourseHasBound
    }

    // 3. 检查是否已被其他教师绑定
    existingTeacher, err := s.bindRepo.GetByCourseID(ctx, cID)
    if err != nil {
        return err
    }
    if existingTeacher != nil {
        return errcode.CourseHasBound
    }

    // 4. 创建绑定关系
    bind := &model.Bind{
        TeacherID: tID,
        CourseID:  cID,
    }
    if err := s.bindRepo.Create(ctx, bind); err != nil {
        return err
    }

    // 5. 更新课程的教师ID
    return s.courseRepo.Update(ctx, cID, map[string]interface{}{
        "teacher_id": tID,
    })
}
```

#### UnbindCourse - 解绑课程

```go
func (s *CourseService) UnbindCourse(ctx context.Context, courseID, teacherID string) error {
    cID, _ := strconv.Atoi(courseID)
    tID, _ := strconv.Atoi(teacherID)

    // 1. 检查绑定是否存在
    boundTeacher, err := s.bindRepo.GetByCourseID(ctx, cID)
    if err != nil {
        return err
    }
    if boundTeacher == nil {
        return errcode.CourseNotBind
    }

    // 2. 验证是否是绑定该课程的教师
    if *boundTeacher != tID {
        return errcode.PermDenied
    }

    // 3. 删除绑定
    if err := s.bindRepo.DeleteByCourseID(ctx, cID); err != nil {
        return err
    }

    // 4. 更新课程的教师ID为nil
    return s.courseRepo.Update(ctx, cID, map[string]interface{}{
        "teacher_id": nil,
    })
}
```

#### GetTeacherCourses - 获取教师的课程列表

```go
func (s *CourseService) GetTeacherCourses(ctx context.Context, teacherID string) ([]*model.Course, error) {
    tID, _ := strconv.Atoi(teacherID)
    return s.bindRepo.GetByTeacherID(ctx, tID)
}
```

---

## 5. API 接口

### 5.1 路由配置

```go
// 课程管理路由
course := v1.Group("/course")
{
    course.GET("/get", r.courseHandler.GetCourse)
    course.POST("/create", r.authMiddleware.RequireAuth(), r.authMiddleware.RequireAdmin(), r.courseHandler.CreateCourse)
    course.POST("/schedule", r.authMiddleware.RequireAuth(), r.authMiddleware.RequireAdmin(), r.courseHandler.ScheduleCourse)
}

// 教师管理路由
teacher := v1.Group("/teacher")
{
    teacher.GET("/get_course", r.courseHandler.GetTeacherCourses)
    teacher.POST("/bind_course", r.authMiddleware.RequireAuth(), r.authMiddleware.RequireAdmin(), r.courseHandler.BindCourse)
    teacher.POST("/unbind_course", r.authMiddleware.RequireAuth(), r.authMiddleware.RequireAdmin(), r.courseHandler.UnbindCourse)
}
```

### 5.2 接口详情

#### GET /api/v1/course/get - 获取课程

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| course_id | string | 是 | 课程ID |

**响应示例**:
```json
{
  "code": 0,
  "data": {
    "course_id": "1",
    "name": "高等数学",
    "capacity": 100,
    "teacher_id": "2"
  }
}
```

#### POST /api/v1/course/create - 创建课程

**请求体**:
```json
{
  "name": "高等数学",
  "cap": 100
}
```

#### POST /api/v1/course/schedule - 批量排课

**请求体**:
```json
{
  "teacher_course_relationship": {
    "2": ["1", "2", "3"],  // 教师ID: 课程ID列表
    "3": ["4", "5"]
  }
}
```

#### GET /api/v1/teacher/get_course - 获取教师课程

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| teacher_id | string | 是 | 教师ID |

#### POST /api/v1/teacher/bind_course - 绑定课程

**请求体**:
```json
{
  "course_id": "1",
  "teacher_id": "2"
}
```

#### POST /api/v1/teacher/unbind_course - 解绑课程

**请求体**:
```json
{
  "course_id": "1",
  "teacher_id": "2"
}
```

---

## 6. 业务规则

### 6.1 课程创建规则

| 规则 | 说明 |
|------|------|
| 课程名称 | 必填，1-100 字符 |
| 容量 | 必填，必须大于 0 |
| 教师 | 可为空，后续通过绑定分配 |

### 6.2 绑定规则

| 规则 | 说明 |
|------|------|
| 一门课程只能被一位教师绑定 | 通过 Bind 表的联合主键保证 |
| 课程必须先存在 | 绑定前检查课程是否存在 |
| 教师必须存在 | 绑定前检查教师是否存在 |
| 已绑定的课程不能重复绑定 | 检查 TeacherID 和 Bind 表 |

### 6.3 解绑规则

| 规则 | 说明 |
|------|------|
| 只有绑定该课程的教师可以解绑 | 权限校验 |
| 解绑后不影响已选课的学生 | 保持 Choice 记录 |

---

## 7. 关联关系

### 7.1 ER 图

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   Member    │         │   Course    │         │   Choice    │
├─────────────┤         ├─────────────┤         ├─────────────┤
│ UserID (PK) │    ┌───►│ CourseID(PK)│    ┌───│ StudentID   │
│ Username    │    │    │ Name        │    │   │ CourseID    │
│ UserType    │────┼───►│ Capacity    │◄───┤   └─────────────┘
└─────────────┘    │    │ TeacherID ──┼───┘
       │           │    └─────────────┘
       │ Bind      │
       ▼           │
┌─────────────┐    │
│   Bind      │◄───┘
├─────────────┤
│ TeacherID   │
│ CourseID    │
│ AssignedAt  │
└─────────────┘
```

### 7.2 关系说明

| 关系 | 类型 | 说明 |
|------|------|------|
| Course → Member (TeacherID) | N:1 | 一门课程属于一位教师 |
| Bind → Member (TeacherID) | N:1 | 绑定关系关联教师 |
| Bind → Course | N:1 | 绑定关系关联课程 |
| Choice → Member (StudentID) | N:1 | 选课关系关联学生 |
| Choice → Course | N:1 | 选课关系关联课程 |

---

## 8. 核心代码文件

| 文件 | 路径 | 说明 |
|------|------|------|
| `course.go` | `internal/domain/model/course.go` | Course/Bind/Choice 实体 |
| `course_repo.go` | `internal/domain/repository/course_repo.go` | 仓储接口 |
| `course_repo_impl.go` | `internal/infrastructure/database/course_repo_impl.go` | 仓储实现 |
| `course_service.go` | `internal/domain/service/course_service.go` | 领域服务 |
| `course_handler.go` | `internal/interface/api/handler/course_handler.go` | HTTP 处理器 |

---

## 9. 学习要点

1. **联合主键**: Bind 和 Choice 使用 (TeacherID, CourseID) 和 (StudentID, CourseID) 作为联合主键
2. **外键约束**: Course.TeacherID 关联 Member.UserID
3. **GORM 关联**: 使用 `gorm:"primaryKey"` 定义联合主键
4. **业务规则**: 绑定和解绑时的各种校验逻辑
5. **批量操作**: ScheduleCourse 支持批量排课
