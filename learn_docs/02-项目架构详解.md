# 项目架构详解

## 1. 架构设计理念

本项目采用 **Clean Architecture (清洁架构)** 思想进行设计，将系统划分为四个核心层次，各层职责清晰，依赖关系明确。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Clean Architecture 分层                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│    ┌───────────────────────────────────────────────────────────────┐    │
│    │                      Interface Layer (接口层)                  │    │
│    │   ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │    │
│    │   │   Handler   │  │  Middleware │  │       Router        │   │    │
│    │   └─────────────┘  └─────────────┘  └─────────────────────┘   │    │
│    └───────────────────────────────────────────────────────────────┘    │
│                                  ▲                                      │
│                                  │ 依赖                                  │
│    ┌───────────────────────────────────────────────────────────────┐    │
│    │                     Application Layer (应用层)                 │    │
│    │   ┌─────────────────────────┐  ┌─────────────────────────┐   │    │
│    │   │           DTO           │  │     Application Service │   │    │
│    │   │   (数据传输对象)         │  │     (选课等应用服务)     │   │    │
│    │   └─────────────────────────┘  └─────────────────────────┘   │    │
│    └───────────────────────────────────────────────────────────────┘    │
│                                  ▲                                      │
│                                  │ 依赖                                  │
│    ┌───────────────────────────────────────────────────────────────┐    │
│    │                       Domain Layer (领域层)                   │    │
│    │   ┌─────────────────────────┐  ┌─────────────────────────┐   │    │
│    │   │          Model          │  │   Repository Interface  │   │    │
│    │   │   (实体: Member等)      │  │   (仓储接口定义)         │   │    │
│    │   └─────────────────────────┘  └─────────────────────────┘   │    │
│    │   ┌─────────────────────────┐                                │    │
│    │   │   Domain Service        │                                │    │
│    │   │   (领域业务逻辑)         │                                │    │
│    │   └─────────────────────────┘                                │    │
│    └───────────────────────────────────────────────────────────────┘    │
│                                  ▲                                      │
│                                  │ 依赖                                  │
│    ┌───────────────────────────────────────────────────────────────┐    │
│    │                   Infrastructure Layer (基础设施层)           │    │
│    │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │    │
│    │   │ Database │  │   Redis  │  │    MQ    │  │  Encrypt   │  │    │
│    │   └──────────┘  └──────────┘  └──────────┘  └────────────┘  │    │
│    └───────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 各层职责

### 2.1 Interface Layer (接口层)

**职责**: 处理 HTTP 请求/响应，路由分发，中间件处理

| 组件 | 路径 | 职责 |
|------|------|------|
| Handler | `internal/interface/api/handler/` | 接收请求，调用服务，返回响应 |
| Middleware | `internal/interface/api/middleware/` | 认证、限流、日志等横切关注点 |
| Router | `internal/interface/api/router/` | 路由定义和分组 |

**依赖关系**:
```
Handler → Application Service → Domain Service → Repository Interface
```

### 2.2 Application Layer (应用层)

**职责**: 用例编排，数据传输，对外提供 API

| 组件 | 路径 | 职责 |
|------|------|------|
| DTO | `internal/application/dto/` | 数据传输对象，API 请求/响应格式 |
| Service | `internal/application/service/` | 应用服务，高并发场景处理 |

**设计特点**:
- DTO 隔离内部模型与外部接口
- Application Service 编排多个领域服务
- 选课服务专门处理高并发逻辑

### 2.3 Domain Layer (领域层)

**职责**: 业务核心，领域规则，仓储接口定义

| 组件 | 路径 | 职责 |
|------|------|------|
| Model | `internal/domain/model/` | 实体定义，校验规则 |
| Repository | `internal/domain/repository/` | 数据访问接口抽象 |
| Service | `internal/domain/service/` | 领域业务逻辑 |

**核心实体**:
- `Member`: 用户 (管理员/教师/学生)
- `Course`: 课程
- `Bind`: 教师-课程绑定
- `Choice`: 学生-课程选课关系

### 2.4 Infrastructure Layer (基础设施层)

**职责**: 技术实现，外部服务集成

| 组件 | 路径 | 职责 |
|------|------|------|
| Database | `internal/infrastructure/database/` | MySQL + GORM 实现 |
| Redis | `internal/infrastructure/redis/` | Redis 客户端封装 |
| MQ | `internal/infrastructure/mq/` | RocketMQ 客户端 |
| Encrypt | `internal/infrastructure/encrypt/` | 密码加密 (bcrypt) |

---

## 3. 依赖注入设计

项目采用手动依赖注入，通过构造函数传递依赖。

### 3.1 典型依赖链

```go
// 路由初始化时的依赖注入
router := NewRouter(
    authHandler,      // 依赖 AuthService
    memberHandler,    // 依赖 MemberService
    courseHandler,    // 依赖 CourseService
    authMiddleware,   // 依赖 Redis 等
    limiterMiddleware,
)

// AuthHandler 依赖
NewAuthHandler(authService *service.AuthService, sessionKey, cookieName string)

// AuthService 依赖
NewAuthService(memberRepo repository.IMemberRepo, redis *redis.Client)
```

### 3.2 依赖方向

```
┌──────────────────────────────────────────────────────────────┐
│                    依赖方向 (从外到内)                         │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│   Interface ──► Application ──► Domain ──► Infrastructure   │
│       │              │             │            │            │
│       ▼              ▼             ▼            ▼            │
│    Gin Handler   Use Case      Business    MySQL/Redis      │
│    Middleware    Orchestration  Rules      MQ/etc           │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**核心原则**: 内层不依赖外层，外层依赖内层的抽象 (接口)

---

## 4. 请求处理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           请求处理流程                                    │
└─────────────────────────────────────────────────────────────────────────┘

客户端请求
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1. Gin Server (router.go)                                           │
│     - 全局限流 middleware                                             │
│     - 日志、恢复 middleware                                           │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. Auth Middleware (auth.go)                                        │
│     - 从 Cookie 读取 sessionId                                        │
│     - 从 Redis 获取 Session 数据                                      │
│     - 验证用户类型权限                                                 │
│     - 设置 c.Set("session_data", ...)                                │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. Handler (auth_handler.go / course_handler.go 等)                 │
│     - 参数绑定与校验                                                   │
│     - 调用 Application Service                                       │
│     - 返回 JSON 响应                                                  │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. Application Service (selection_app.go 等)                        │
│     - 高并发处理 (限流、Redis 原子操作)                                │
│     - 消息队列异步处理                                                │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. Domain Service (course_service.go / member_service.go 等)        │
│     - 业务规则校验                                                    │
│     - 调用 Repository 接口                                            │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  6. Repository Interface (course_repo.go / member_repo.go 等)        │
│     - 定义数据访问接口                                                │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  7. Infrastructure (course_repo_impl.go / member_repo_impl.go 等)    │
│     - GORM 实现数据库操作                                            │
│     - Redis 缓存操作                                                 │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
数据库 / Redis / MQ
```

---

## 5. 关键设计模式

### 5.1 仓储模式 (Repository Pattern)

**目的**: 隔离数据访问细节，便于测试和替换实现

```go
// 领域层定义接口
type ICourseRepo interface {
    Create(ctx context.Context, course *Course) error
    GetByID(ctx context.Context, id int) (*Course, error)
    List(ctx context.Context, offset, limit int) ([]*Course, error)
    Update(ctx context.Context, id int, updates map[string]interface{}) error
}

// 基础设施层实现
type CourseRepoImpl struct {
    db *gorm.DB
}

func (r *CourseRepoImpl) Create(ctx context.Context, course *Course) error {
    return r.db.WithContext(ctx).Create(course).Error
}
```

### 5.2 依赖注入 (Dependency Injection)

**目的**: 解耦组件，提高可测试性

```go
// 通过构造函数注入依赖
type CourseService struct {
    courseRepo repository.ICourseRepo
    bindRepo   repository.IBindRepo
    choiceRepo repository.IChoiceRepo
}

func NewCourseService(
    courseRepo repository.ICourseRepo,
    bindRepo repository.IBindRepo,
    choiceRepo repository.IChoiceRepo,
) *CourseService {
    return &CourseService{
        courseRepo: courseRepo,
        bindRepo:   bindRepo,
        choiceRepo: choiceRepo,
    }
}
```

### 5.3 服务层分层

| 服务类型 | 位置 | 职责 |
|---------|------|------|
| Domain Service | `domain/service/` | 业务规则、领域逻辑 |
| Application Service | `application/service/` | 用例编排、高并发处理 |

---

## 6. 配置管理

采用 Viper 进行配置管理，支持环境变量。

```go
// config.yaml 结构
app:
  name: "course-selection-system"
  host: "0.0.0.0"
  port: 8080

database:
  host: "localhost"
  port: 3306
  username: "root"
  password: "${DB_PASSWORD}"  # 环境变量支持

redis:
  host: "localhost"
  port: 6379
  password: "${REDIS_PASSWORD}"

rocketmq:
  nameserver: "localhost:9876"
```

---

## 7. 学习建议

### 7.1 推荐的阅读顺序

1. **先看路由**: [router.go](internal/interface/api/router/router.go) 了解整体 API 结构
2. **再看模型**: [course.go](internal/domain/model/course.go), [member.go](internal/domain/model/member.go) 理解数据结构
3. **接着看服务**: [course_service.go](internal/domain/service/course_service.go) 理解业务逻辑
4. **深入实现**: [course_repo_impl.go](internal/infrastructure/database/course_repo_impl.go) 了解数据访问
5. **最后看处理器**: [course_handler.go](internal/interface/api/handler/course_handler.go) 理解请求处理

### 7.2 关键文件清单

| 文件 | 层级 | 重要性 |
|------|------|--------|
| `router.go` | Interface | 高 - 路由总览 |
| `auth.go` (middleware) | Interface | 高 - 权限控制 |
| `selection_app.go` | Application | 高 - 高并发选课 |
| `course_service.go` | Domain | 高 - 课程业务 |
| `mysql.go` | Infrastructure | 中 - 数据库初始化 |
| `redis.go` | Infrastructure | 中 - 缓存操作 |
