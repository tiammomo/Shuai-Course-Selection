# 部署与运维

## 1. 部署方式

系统支持两种部署方式：
- **Docker Compose**: 一键部署，适合开发和测试环境
- **手动部署**: 手动配置环境，适合生产环境

---

## 2. Docker Compose 部署

### 2.1 目录结构

```
deploy/
├── Dockerfile
└── docker-compose.yml
```

### 2.2 docker-compose.yml

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - SESSION_KEY=${SESSION_KEY}
    depends_on:
      - mysql
      - redis
      - rocketmq
    networks:
      - course-selection
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=course_select
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - course-selection
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - course-selection
    restart: unless-stopped

  rocketmq:
    image: apache/rocketmq:4.9.4
    ports:
      - "9876:9876"
      - "10911:10911"
      - "10912:10912
    volumes:
      - rocketmq_data:/store
      - rocketmq_logs:/logs
    environment:
      - JAVA_OPT_EXT=-Xms512m -Xmx512m
    networks:
      - course-selection
    restart: unless-stopped
    command: sh mqnamesrv && sh mqbroker -n localhost:9876

  rocketmq-console:
    image: pangliang/rocketmq-console-ng
    ports:
      - "8081:8080"
    environment:
      - JAVA_OPTS=-Xmx256m -Xms128m
      - rocketmq.config.namesrvAddr=rocketmq:9876
    depends_on:
      - rocketmq
    networks:
      - course-selection
    restart: unless-stopped

networks:
  course-selection:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  rocketmq_data:
  rocketmq_logs:
```

### 2.3 启动命令

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f app

# 停止所有服务
docker-compose down

# 停止并删除数据卷
docker-compose down -v
```

### 2.4 服务访问

| 服务 | 端口 | 地址 |
|------|------|------|
| API 服务 | 8080 | http://localhost:8080 |
| MySQL | 3306 | localhost:3306 |
| Redis | 6379 | localhost:6379 |
| RocketMQ Console | 8081 | http://localhost:8081 |

---

## 3. Dockerfile

```dockerfile
# 构建阶段
FROM golang:1.24-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY go.mod go.sum ./
RUN go mod download

# 复制源代码
COPY . .

# 编译
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# 运行阶段
FROM alpine:latest

RUN apk --no-cache add ca-certificates tzdata

WORKDIR /app

# 从构建阶段复制编译产物
COPY --from=builder /app/main .
COPY --from=builder /app/config.yaml .

# 设置时区
ENV TZ=Asia/Shanghai

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["./main"]
```

---

## 4. 手动部署

### 4.1 环境要求

| 组件 | 版本要求 |
|------|----------|
| Go | 1.24+ |
| MySQL | 8.0+ |
| Redis | 7.x+ |
| RocketMQ | 4.9+ (可选) |

### 4.2 安装步骤

#### 步骤 1: 安装 MySQL

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server-8.0

# 启动服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

#### 步骤 2: 安装 Redis

```bash
# Ubuntu/Debian
sudo apt install redis-server

# 启动服务
sudo systemctl start redis
sudo systemctl enable redis
```

#### 步骤 3: 安装 RocketMQ (可选)

```bash
# 下载并解压
wget https://archive.apache.org/dist/rocketmq/4.9.4/rocketmq-all-4.9.4-bin-release.zip
unzip rocketmq-all-4.9.4-bin-release.zip

# 启动 NameServer
nohup sh bin/mqnamesrv &

# 启动 Broker
nohup sh bin/mqbroker -n localhost:9876 &
```

#### 步骤 4: 部署应用

```bash
# 1. 克隆代码
git clone <repository-url>
cd Shuai-Course-Selection

# 2. 配置环境变量
export DB_PASSWORD="your_password"
export REDIS_PASSWORD="your_password"
export SESSION_KEY="your_session_key"

# 3. 编译
go build -o server.exe .

# 4. 运行
./server.exe
```

### 4.5 初始化数据库

```bash
# 执行 SQL 脚本
mysql -u root -p course_select < sql/course_select_v1.01.sql
```

---

## 5. 配置说明

### 5.1 完整配置

```yaml
# config.yaml

app:
  name: "course-selection-system"
  host: "0.0.0.0"
  port: 8080
  env: "development"

database:
  host: "localhost"
  port: 3306
  username: "root"
  password: "${DB_PASSWORD}"
  name: "course_select"
  charset: "utf8mb4"
  max_idle_conns: 10
  max_open_conns: 100

redis:
  host: "localhost"
  port: 6379
  password: "${REDIS_PASSWORD}"
  db: 0
  pool_size: 100
  dial_timeout: 5s
  read_timeout: 3s
  write_timeout: 3s

rocketmq:
  nameserver: "localhost:9876"
  group_id: "course-select-group"
  topic: "course-booking-topic"
  instance_name: "course-selection-instance"

auth:
  session_key: "${SESSION_KEY}"
  session_expire_hours: 24
  cookie_name: "camp-session"

rate_limit:
  qps: 4000
  burst: 5000

logging:
  level: "info"
  format: "json"
  output: "stdout"
  path: "logs"

metrics:
  enabled: true
  path: "/metrics"
```

### 5.2 环境变量

| 变量 | 说明 | 示例 |
|------|------|------|
| DB_PASSWORD | MySQL 密码 | mysecretpassword |
| REDIS_PASSWORD | Redis 密码 | redis_secret |
| SESSION_KEY | Session 加密密钥 | random_string_32 |

---

## 6. 运维监控

### 6.1 健康检查

```bash
# API 健康检查
curl http://localhost:8080/health

# 响应
{
  "status": "ok"
}
```

### 6.2 监控指标

系统集成 Prometheus 监控：

```yaml
metrics:
  enabled: true
  path: "/metrics"
```

访问 http://localhost:8080/metrics 查看监控指标。

### 6.3 日志配置

```yaml
logging:
  level: "info"       # debug, info, warn, error
  format: "json"      # json, console
  output: "stdout"    # stdout, file, both
  path: "logs"        # 日志文件路径
```

### 6.4 日志级别

| 级别 | 说明 |
|------|------|
| debug | 调试信息，开发环境使用 |
| info | 普通日志，默认级别 |
| warn | 警告信息 |
| error | 错误信息 |

---

## 7. 高可用部署

### 7.1 架构图

```
                          ┌─────────────────┐
                          │   Nginx/LB      │
                          │   (负载均衡)    │
                          └────────┬────────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
      ┌───────────────┐   ┌───────────────┐   ┌───────────────┐
      │   App Node 1  │   │   App Node 2  │   │   App Node N  │
      └───────┬───────┘   └───────┬───────┘   └───────┬───────┘
              │                   │                    │
              └────────────────────┼────────────────────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
      ┌───────────────┐   ┌───────────────┐   ┌───────────────┐
      │  MySQL Master │   │  Redis Cluster│   │  RocketMQ     │
      └───────────────┘   └───────────────┘   └───────────────┘
```

### 7.2 Nginx 配置

```nginx
upstream course_selection {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
    keepalive 32;
}

server {
    listen 80;
    server_name course.example.com;

    location / {
        proxy_pass http://course_selection;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 7.3 推荐配置

| 组件 | 生产配置 |
|------|----------|
| App 实例数 | 3+ |
| MySQL | 主从复制 |
| Redis | 主从 + Sentinel |
| RocketMQ | 集群部署 |
| Nginx | 负载均衡 |

---

## 8. 故障排查

### 8.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 连接 MySQL 失败 | 密码错误、权限问题 | 检查环境变量配置 |
| Redis 连接超时 | 网络、防火墙 | 检查 6379 端口 |
| 选课返回 500 | 数据库连接池耗尽 | 增加 MaxOpenConns |
| Session 丢失 | Redis 密码错误 | 检查 REDIS_PASSWORD |

### 8.2 调试命令

```bash
# 检查 MySQL 连接
mysql -u root -p -e "SELECT 1"

# 检查 Redis 连接
redis-cli ping

# 检查应用日志
tail -f logs/app.log

# 检查端口占用
netstat -tlnp | grep 8080
```

---

## 9. 备份与恢复

### 9.1 MySQL 备份

```bash
# 备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
mysqldump -u root -p${DB_PASSWORD} course_select > ${BACKUP_DIR}/course_select_${DATE}.sql
```

### 9.2 Redis 备份

```bash
# RDB 持久化备份
redis-cli BGSAVE
cp /var/lib/redis/dump.rdb /backup/redis/
```

### 9.3 恢复数据

```bash
# MySQL 恢复
mysql -u root -p course_select < backup.sql

# Redis 恢复
redis-cli BGREWRITEAOF
```

---

## 10. 安全建议

### 10.1 生产环境配置

| 安全措施 | 配置建议 |
|----------|----------|
| HTTPS | 使用 TLS/SSL 证书 |
| 防火墙 | 只开放必要端口 |
| 密码策略 | 使用强密码，定期更换 |
| 网络隔离 | MySQL/Redis 不直接暴露公网 |

### 10.2 Docker 安全

```yaml
# docker-compose.yml 安全配置
services:
  app:
    # 不以 root 用户运行
    user: "1000:1000"
    # 只读文件系统
    read_only: true
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
```

---

## 11. 性能调优

### 11.1 MySQL 调优

```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
max_connections = 500
innodb_buffer_pool_size = 2G
innodb_log_file_size = 512M
innodb_flush_log_at_trx_commit = 2
```

### 11.2 Redis 调优

```conf
# /etc/redis/redis.conf
maxmemory 1gb
maxmemory-policy allkeys-lru
tcp-keepalive 300
```

### 11.3 Go 应用调优

```go
// 增加 GOMAXPROCS
runtime.GOMAXPROCS(runtime.NumCPU() * 2)

// 增加文件描述符
// ulimit -n 65535
```
