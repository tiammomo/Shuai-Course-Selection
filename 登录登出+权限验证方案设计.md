# 登录登出 + 权限验证方案设计

## 1. 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端 (Browser/APP)                      │
│    - 存储 SessionID 于 Cookie (key: camp-session)                │
│    - 自动携带 Cookie 到后续请求                                   │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API Gateway / Gin Server                    │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   AuthMiddleware                         │   │
│  │  1. 从 Cookie 读取 sessionId                             │   │
│  │  2. 从 Redis 获取 Session 数据                           │   │
│  │  3. 验证用户类型权限                                      │   │
│  │  4. 设置 c.Set("session_data", ...) 供 Handler 使用      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│              ┌───────────────┼───────────────┐                  │
│              ▼               ▼               ▼                  │
│         /auth/login    /teacher/*       /student/*              │
│         /auth/logout   /admin/*         /other/*                │
│         /auth/whoami                                            │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                           Redis (Session 存储)                   │
│   Key: session:{sessionId}                                      │
│   Value: JSON {                                                 │
│       "user_id": "1",                                           │
│       "username": "admin",                                      │
│       "nickname": "管理员",                                     │
│       "user_type": 1  // 0=未知, 1=管理员, 2=教师, 3=学生       │
│   }                                                             │
│   TTL: 3600 秒 (1小时)                                          │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 用户类型定义

| user_type | 角色 | 权限描述 |
|-----------|------|----------|
| 0 | 未知 | 未登录或无效用户 |
| 1 | 管理员 | 系统管理，完全访问权限 |
| 2 | 教师 | 课程管理、查看学生选课 |
| 3 | 学生 | 选课、退课、查看课表 |

## 3. 登录流程

### 3.1 时序图

```
用户                    Handler                AuthService           Redis          DB
 │                        │                      │                   │             │
 │  POST /auth/login      │                      │                   │             │
 │ {username, password}   │                      │                   │             │
 │───────────────────────>│                      │                   │             │
 │                        │ Login(username, pwd) │                   │             │
 │                        │─────────────────────>│                   │             │
 │                        │                      │ GetByUsername     │             │
 │                        │                      │───────────────────>             │
 │                        │                      │                   │ SELECT ...  │
 │                        │                      │                   │────────────>│
 │                        │                      │    member         │             │
 │                        │                      │<───────────────────│             │
 │                        │                      │ ComparePassword   │             │
 │                        │                      │ (bcrypt)          │             │
 │                        │                      │                   │             │
 │                        │    member / error    │                   │             │
 │                        │<─────────────────────│                   │             │
 │                        │                      │                   │             │
 │                        │ GenerateSessionID    │                   │             │
 │                        │─────────────────────>│                   │             │
 │                        │                      │                   │             │
 │                        │ CreateSession(session, member)          │             │
 │                        │─────────────────────>│                   │             │
 │                        │                      │ SET session:{id}  │             │
 │                        │                      │───────────────────>             │
 │                        │                      │                   │             │
 │                        │ Set-Cookie: camp-session={id}           │             │
 │<───────────────────────│                      │                   │             │
 │  200 {user_id: "1"}    │                      │                   │             │
```

### 3.2 密码安全

- **密码加密**: 使用 `bcrypt` 算法 (Cost = 10)
- **禁止**: 明文传输、MD5 存储
- **密码强度要求**:
  - 最少 8 位
  - 包含大小写字母
  - 包含数字

### 3.3 Session 管理

| 配置项 | 值 | 说明 |
|--------|-----|------|
| Cookie Name | `camp-session` | Session ID 存储的 Cookie 名称 |
| Session TTL | 3600s | Redis 中 Session 过期时间 |
| Cookie MaxAge | 3600 | Cookie 存活时间 |
| Cookie Secure | false | 开发环境设为 false |
| Cookie HttpOnly | true | 防止 XSS 攻击 |

### 3.4 登录 API

**POST /auth/login**

Request:
```json
{
  "username": "admin",
  "password": "AdminPass123"
}
```

Response (成功):
```json
{
  "code": 0,
  "data": {
    "user_id": "1"
  }
}
```

Response (失败):
```json
{
  "code": 10001,
  "msg": "用户名或密码错误"
}
```

## 4. 权限验证中间件

### 4.1 AuthMiddleware

```go
// RequireAuth - 需要登录
func (m *AuthMiddleware) RequireAuth() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. 从 Cookie 获取 sessionId
        sessionId, err := c.Cookie("camp-session")
        if err != nil {
            c.JSON(200, response.Unauthorized("用户未登录"))
            c.Abort()
            return
        }

        // 2. 从 Redis 获取 Session 数据
        session := sessions.Default(c)
        v := session.Get(m.sessionKey) // sessionKey = "session_data"
        if v == nil {
            c.JSON(200, response.Unauthorized("登录已过期"))
            c.Abort()
            return
        }

        // 3. 类型断言并设置到 Context
        data, ok := v.(map[string]interface{})
        if !ok {
            c.JSON(200, response.Unauthorized("无效的会话"))
            c.Abort()
            return
        }

        c.Set("session_data", data)
        c.Next()
    }
}

// RequireAdmin - 需要管理员权限
func (m *AuthMiddleware) RequireAdmin() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 先经过 RequireAuth
        m.RequireAuth()(c)
        if c.IsAborted() {
            return
        }

        // 检查 user_type == 1
        data, _ := c.Get("session_data")
        sessionData := data.(map[string]interface{})
        userType := sessionData["user_type"].(int)

        if userType != 1 {
            c.JSON(200, response.Forbidden("需要管理员权限"))
            c.Abort()
            return
        }

        c.Next()
    }
}
```

### 4.2 路由权限配置

```go
// 公开路由 (无需登录)
publicRoutes := router.Group("/auth")
publicRoutes.POST("/login", authHandler.Login)
publicRoutes.POST("/logout", authHandler.Logout)
publicRoutes.GET("/whoami", authHandler.WhoAmI)

// 教师路由 (需要教师或管理员权限)
teacherRoutes := router.Group("/teacher")
teacherRoutes.Use(authMiddleware.RequireAuth())
teacherRoutes.GET("/course", courseHandler.GetTeacherCourses)
teacherRoutes.POST("/course", courseHandler.CreateCourse)

// 学生路由 (需要学生权限)
studentRoutes := router.Group("/student")
studentRoutes.Use(authMiddleware.RequireAuth())
studentRoutes.GET("/course", courseHandler.GetStudentCourses)
studentRoutes.POST("/book", selectionAppService.BookCourse)

// 管理员路由 (需要管理员权限)
adminRoutes := router.Group("/admin")
adminRoutes.Use(authMiddleware.RequireAdmin())
adminRoutes.GET("/users", adminHandler.ListUsers)
```

## 5. 登出流程

### 5.1 时序图

```
用户                    Handler                Redis
 │                        │                      │
 │  POST /auth/logout     │                      │
 │───────────────────────>│                      │
 │                        │ Get sessionId from Cookie
 │                        │                      │
 │                        │ DEL session:{id}    │
 │                        │─────────────────────>│
 │                        │                      │
 │                        │ Set-Cookie: maxAge=-1│
 │<───────────────────────│                      │
 │  200 {code: 0}         │                      │
```

### 5.2 登出 API

**POST /auth/logout**

Request: 无需参数，自动从 Cookie 获取 sessionId

Response:
```json
{
  "code": 0,
  "msg": "登出成功"
}
```

## 6. 获取当前用户信息

### 6.1 API

**GET /auth/whoami**

Response:
```json
{
  "code": 0,
  "data": {
    "user_id": "1",
    "username": "admin",
    "nickname": "管理员",
    "user_type": 1
  }
}
```

## 7. 安全增强建议

### 7.1 Session 安全

| 风险点 | 防护措施 |
|--------|----------|
| Session 劫持 | HttpOnly Cookie, HTTPS 传输 |
| Session 固定攻击 | 登录后重新生成 SessionID |
| CSRF 攻击 | 添加 CSRF Token 验证 |
| XSS 攻击 | Content Security Policy |

### 7.2 密码安全

| 风险点 | 防护措施 |
|--------|----------|
| 暴力破解 | 登录失败次数限制 (5次/分钟) |
| 弱密码 | 密码强度校验 |
| 彩虹表 | 使用 bcrypt 加盐 |

### 7.3 速率限制

```go
// 使用 golang.org/x/time/rate
limiter := rate.NewLimiter(10, 100) // 10 QPS, 100 burst

// 全局限流
router.Use(limitMiddleware(limiter))

// 登录限流 (更严格)
authGroup.POST("/login").Use(limitMiddleware(rate.NewLimiter(5, 10)))
```

## 8. Session 数据结构

### 8.1 Redis Key 格式

```
Key: session:{uuid}
TTL: 3600 seconds
Value: JSON String
```

### 8.2 Value 示例

```json
{
  "user_id": "1",
  "username": "admin",
  "nickname": "管理员",
  "user_type": 1
}
```

### 8.3 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| user_id | string | 用户ID (避免多次类型转换) |
| username | string | 用户名 |
| nickname | string | 昵称 |
| user_type | int | 用户类型 (1=管理员, 2=教师, 3=学生) |

## 9. 错误码定义

| 错误码 | 说明 |
|--------|------|
| 10000 | 成功 |
| 10001 | 用户名或密码错误 |
| 10002 | 用户不存在 |
| 10003 | 用户已禁用 |
| 10004 | 登录已过期 |
| 10005 | 需要管理员权限 |
| 10006 | 需要学生权限 |
